---
version: "3"

tasks:

  build:
    desc: Send a workflow dispatch to build containers
    cmds:
      - |-
        find ./apps -name metadata.json5 | while read -r metadata; do
            declare -a __channels=()
            app="$(jq --raw-output '.app' "${metadata}")"
            if [[ "$(jq --raw-output '.base' "${metadata}")" == {{.BASE}} ]]; then
                continue;
            fi
            jq --raw-output -c '.channels | .[]' "${metadata}" | while read -r channels; do
                __channels+=("$(jq --raw-output '.name' <<< "${channels}")")
            done
            gh workflow run manual-release.yaml -f app="${app}" -f channels="$(IFS=,; printf '%s' "${__channels[*]}")" -f push=true
        done
